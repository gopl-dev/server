// Code generated by templ - DO NOT EDIT.

// templ: version: v0.3.960
package page

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

import "github.com/gopl-dev/server/frontend/component/icon"

func FilterEventLogsPage() templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 1, "<script src=\"/assets/http_helpers.js\"></script><script src=\"/assets/helpers.js\"></script><script>\r\n    function eventLogsPage() {\r\n        return {\r\n            logs: [],\r\n            loading: false,\r\n            error: '',\r\n            total: 0,\r\n            loadedOnce: false,\r\n\r\n            filters: {\r\n                page: 1,\r\n                per_page: 100,\r\n            },\r\n\r\n            // changes modal state\r\n            selectedLog: null,\r\n            diffLoading: false,\r\n            diffError: null,\r\n            diff: { changes: [] },\r\n\r\n            get diffRows() {\r\n                const fields = this.diff?.changes && Array.isArray(this.diff.changes) ? this.diff.changes : [];\r\n\r\n                return fields.map((field) => ({\r\n                    key: field.key,\r\n                    type: field.type,\r\n                    hasDiff: !!(field.diff && field.diff !== ''),\r\n                    current: this.renderValue(field, 'current'),\r\n                    proposed: this.renderValue(field, 'proposed'),\r\n                }));\r\n            },\r\n\r\n            renderValue(field, side) {\r\n                // If field has diff property and it's not empty, show diff\r\n                if (field.diff && field.diff !== '') {\r\n                    const html = (field.diff || '').replace(/\\n/g, '<br/>');\r\n                    return { kind: 'diff', html: html };\r\n                }\r\n\r\n                const value = field[side];\r\n                if (value === null || value === undefined || value === '') {\r\n                    return { kind: 'text', text: '' };\r\n                }\r\n\r\n                switch (field.type) {\r\n                    case 'image':\r\n                        return { kind: 'image', src: `/files/${value}/?preview`, alt: 'preview' };\r\n                    case 'list':\r\n                        const items = Array.isArray(value) ? value : [];\r\n                        const hasObjects = items.length > 0 && typeof items[0] === 'object' && items[0] !== null;\r\n\r\n                        if (hasObjects) {\r\n                            return {\r\n                                kind: 'list-objects',\r\n                                items: items.map(item => {\r\n                                    if (typeof item === 'object' && item !== null) {\r\n                                        return Object.entries(item)\r\n                                            .filter(([key, val]) => val !== null && val !== undefined && val !== '')\r\n                                            .map(([key, val]) => `${key}: ${val}`)\r\n                                            .join(', ');\r\n                                    }\r\n                                    return String(item);\r\n                                })\r\n                            };\r\n                        }\r\n\r\n                        return { kind: 'list', items: items };\r\n                    case 'text':\r\n                    default:\r\n                        return { kind: 'text', text: String(value) };\r\n                }\r\n            },\r\n\r\n            get totalPages() {\r\n                return Math.max(1, Math.ceil(this.total / this.filters.per_page))\r\n            },\r\n\r\n            readFromURL() {\r\n                const url = new URL(window.location.href)\r\n\r\n                const p = parseInt(url.searchParams.get('page') || '', 10)\r\n                if (Number.isFinite(p) && p > 0) this.filters.page = p\r\n                else this.filters.page = 1\r\n            },\r\n\r\n            writeToURL() {\r\n                const url = new URL(window.location.href)\r\n\r\n                if (this.filters.page === 1) url.searchParams.delete('page')\r\n                else url.searchParams.set('page', String(this.filters.page))\r\n\r\n                window.history.replaceState({}, '', url.toString())\r\n            },\r\n\r\n            onPopState() {\r\n                this.readFromURL()\r\n                this.load({ syncURL: false, scrollTop: true })\r\n            },\r\n\r\n            scrollToTop() {\r\n                if (window.scrollY > 80) {\r\n                    window.scrollTo({ top: 0, behavior: 'smooth' })\r\n                }\r\n            },\r\n\r\n            get pageButtons() {\r\n                const max = this.totalPages\r\n                const cur = this.filters.page\r\n\r\n                const start = Math.max(2, cur - 3)\r\n                const end = Math.min(max - 1, cur + 3)\r\n\r\n                const btns = []\r\n                for (let p = start; p <= end; p++) btns.push(p)\r\n                return btns\r\n            },\r\n\r\n            get showLeftDots() {\r\n                return this.pageButtons.length > 0 && this.pageButtons[0] > 2\r\n            },\r\n\r\n            get showRightDots() {\r\n                const btns = this.pageButtons\r\n                return btns.length > 0 && btns[btns.length - 1] < this.totalPages - 1\r\n            },\r\n\r\n            gotoPage(p) {\r\n                if (p < 1) p = 1\r\n                if (p > this.totalPages) p = this.totalPages\r\n                if (p === this.filters.page) return\r\n\r\n                this.filters.page = p\r\n                this.load({ syncURL: true, scrollTop: true })\r\n            },\r\n\r\n            buildLogsQS() {\r\n                const qs = new URLSearchParams({\r\n                    page: String(this.filters.page),\r\n                    per_page: String(this.filters.per_page),\r\n                })\r\n\r\n                for (const id of (this.filters.topic_ids ?? [])) {\r\n                    qs.append('topics', id)\r\n                }\r\n\r\n                return qs.toString()\r\n            },\r\n\r\n            async load(opt) {\r\n                const options = opt || { syncURL: true, scrollTop: true }\r\n                if (this.filters.page < 1) this.filters.page = 1\r\n                if (this.loadedOnce && this.filters.page > this.totalPages) {\r\n                    this.filters.page = this.totalPages\r\n                }\r\n\r\n                if (options.scrollTop) this.scrollToTop()\r\n\r\n                this.loading = true\r\n                this.error = ''\r\n\r\n                try {\r\n                    const { resp, data } = await HTTP.requestJSON('/api/event-logs/?' + this.buildLogsQS())\r\n                    if (resp.status !== 200) {\r\n                        this.error = data?.error || 'Failed to load log'\r\n                        return\r\n                    }\r\n\r\n                    this.logs = data?.data ?? []\r\n                    this.total = data?.count ?? 0\r\n                    this.loadedOnce = true\r\n\r\n                    if (this.filters.page > this.totalPages) {\r\n                        this.filters.page = this.totalPages\r\n                        if (options.syncURL) this.writeToURL()\r\n                        return await this.load({ syncURL: false, scrollTop: false })\r\n                    }\r\n\r\n                    if (options.syncURL) this.writeToURL()\r\n                } catch (e) {\r\n                    this.error = e?.message ?? String(e)\r\n                } finally {\r\n                    this.loading = false\r\n                }\r\n            },\r\n\r\n            resetChangesState() {\r\n                this.selectedLog = null;\r\n                this.diffLoading = false;\r\n                this.diffError = null;\r\n                this.diff = { diff: [] };\r\n            },\r\n\r\n            async openChanges(log) {\r\n                this.resetChangesState();\r\n                this.selectedLog = log;\r\n\r\n                // open modal\r\n                this.$refs.changesModal.showModal();\r\n\r\n                // load changes\r\n                await this.loadChanges(log.id);\r\n            },\r\n\r\n            async loadChanges(id) {\r\n                this.diffLoading = true;\r\n                this.diffError = null;\r\n                this.diff = { diff: [] };\r\n\r\n                try {\r\n                    const resp = await fetch(`/api/event-logs/${id}/changes/`);\r\n                    if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);\r\n\r\n                    const payload = await resp.json();\r\n                    this.diff.changes = Array.isArray(payload?.changes) ? payload.changes : [];\r\n                } catch (e) {\r\n                    console.error('Error loading changes:', e);\r\n                    this.diffError = 'Failed to load changes. Please try again.';\r\n                } finally {\r\n                    this.diffLoading = false;\r\n                }\r\n            },\r\n\r\n            closeChangesModal() {\r\n                this.$refs.changesModal.close();\r\n            },\r\n\r\n            init() {\r\n                this.readFromURL()\r\n                window.addEventListener('popstate', () => this.onPopState())\r\n                this.load({ syncURL: false, scrollTop: false })\r\n            },\r\n        }\r\n    }\r\n</script><div x-data=\"eventLogsPage()\"><h1 class=\"text-3xl mb-3\">Look what we did here:</h1><template x-if=\"loading\"><div>Loading…</div></template><template x-if=\"error\"><div class=\"text-red-600\" x-text=\"error\"></div></template><ul class=\"list bg-base-100 text-lg\"><template x-for=\"l in logs\" :key=\"l.id\"><li class=\"list-row flex items-start justify-between gap-4 w-full\"><div class=\"flex-1 min-w-0\"><div x-text=\"l.date\" class=\"text-gray-500 text-xs\"></div><div x-html=\"l.message\"></div></div><div class=\"flex-shrink-0\"><template x-if=\"l.has_changes\"><button class=\"btn btn-sm btn-circle btn-soft btn-info btn-ghost\" @click=\"openChanges(l)\" title=\"View changes\">")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = icon.Diff().Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 2, "</button></template></div></li></template></ul><template x-if=\"!loading && logs.length === 0 && !error\"><div>Nothing here</div></template><!-- Bottom pagination --><div class=\"flex items-center justify-between mt-4\"><div class=\"flex items-center gap-2\"><button class=\"btn btn-sm\" :class=\"filters.page === 1 ? 'btn-active' : ''\" :disabled=\"loading\" @click=\"gotoPage(1)\">1</button><template x-if=\"showLeftDots\"><span class=\"px-1 select-none\">...</span></template><template x-for=\"p in pageButtons\" :key=\"p\"><button class=\"btn btn-sm\" :class=\"p === filters.page ? 'btn-active' : ''\" :disabled=\"loading\" @click=\"gotoPage(p)\" x-text=\"p\"></button></template><template x-if=\"showRightDots\"><span class=\"px-1 select-none\">...</span></template><template x-if=\"totalPages > 1\"><button class=\"btn btn-sm\" :class=\"filters.page === totalPages ? 'btn-active' : ''\" :disabled=\"loading\" @click=\"gotoPage(totalPages)\" x-text=\"totalPages\"></button></template></div></div><!-- Changes modal --><dialog class=\"modal\" x-ref=\"changesModal\" @close=\"resetChangesState()\"><div class=\"modal-box w-11/12 max-w-5xl\"><form method=\"dialog\"><button class=\"btn btn-sm btn-circle btn-ghost absolute right-2 top-2\" aria-label=\"Close\">✕</button></form><div class=\"mt-4\" x-show=\"diffLoading\"><span class=\"loading loading-spinner loading-md\"></span> <span class=\"ml-2\">Loading changes…</span></div><div class=\"changes-diff\" x-show=\"diffRows.some(row => row.hasDiff)\"><ins class=\"badge\">+ inserted</ins>&nbsp;<del class=\"badge\">- removed</del></div><div class=\"mt-4 alert alert-error\" x-show=\"diffError\" x-cloak><span x-text=\"diffError\"></span></div><div class=\"mt-4 overflow-x-auto\" x-show=\"!diffLoading && !diffError\" x-cloak><table class=\"table table-zebra\"><thead x-show=\"diffRows.some(row => !row.hasDiff)\"><tr><th>&nbsp;</th><th>Before</th><th>After</th></tr></thead> <tbody><template x-for=\"row in diffRows\" :key=\"row.key\"><tr><td class=\"align-top font-mono text-sm\" x-text=\"row.key\"></td><!-- Before column --><td class=\"align-top\" :colspan=\"row.hasDiff ? 2 : 1\"><!-- Diff type: shows in full width --><template x-if=\"row.current.kind === 'diff'\"><div x-html=\"row.current.html\" class=\"max-w-none changes-diff\"></div></template><!-- Image --><template x-if=\"row.current.kind === 'image'\"><img :src=\"row.current.src\" :alt=\"row.current.alt\" class=\"max-h-40\"></template><!-- Text --><template x-if=\"row.current.kind === 'text'\"><pre class=\"whitespace-pre-wrap text-sm\" x-text=\"row.current.text\"></pre></template><!-- List --><template x-if=\"row.current.kind === 'list'\"><ul class=\"list-disc list-inside\"><template x-for=\"item in row.current.items\" :key=\"item\"><li x-text=\"item\"></li></template></ul></template><!-- List of objects --><template x-if=\"row.current.kind === 'list-objects'\"><ul class=\"list-disc list-inside\"><template x-for=\"item in row.current.items\" :key=\"item\"><li x-text=\"item\"></li></template></ul></template></td><!-- After column (only if not diff) --><td class=\"align-top\" x-show=\"!row.hasDiff\"><!-- Image --><template x-if=\"row.proposed.kind === 'image'\"><img :src=\"row.proposed.src\" :alt=\"row.proposed.alt\" class=\"max-h-40\"></template><!-- Text --><template x-if=\"row.proposed.kind === 'text'\"><pre class=\"whitespace-pre-wrap text-sm\" x-text=\"row.proposed.text\"></pre></template><!-- List --><template x-if=\"row.proposed.kind === 'list'\"><ul class=\"list-disc list-inside\"><template x-for=\"item in row.proposed.items\" :key=\"item\"><li x-text=\"item\"></li></template></ul></template><!-- List of objects --><template x-if=\"row.proposed.kind === 'list-objects'\"><ul class=\"list-disc list-inside\"><template x-for=\"item in row.proposed.items\" :key=\"item\"><li x-text=\"item\"></li></template></ul></template></td></tr></template><tr x-show=\"diffRows.length === 0\" x-cloak><td colspan=\"3\" class=\"text-center opacity-60\">No differences</td></tr></tbody></table></div></div><form method=\"dialog\" class=\"modal-backdrop\"><button aria-label=\"Close backdrop\">close</button></form></dialog></div>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

var _ = templruntime.GeneratedTemplate
